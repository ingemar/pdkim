#! /usr/bin/env ruby
require 'pdkim'

RSA_PRIVATE_KEY = <<EOT
-----BEGIN RSA PRIVATE KEY-----
MIICXQIBAAKBgQC5+utIbbfbpssvW0TboF73Seos+1ijdPFGwc/z8Yu12cpjBvRb
5/qRJd83XCySRs0QkK1zWx4soPffbtyJ9TU5mO76M23lIuI5slJ4QLA0UznGxfHd
fXpK9qRnmG6A4HRHC9B93pjTo6iBksRhIeSsTL94EbUJ625i0Lqg4i6NVQIDAQAB
AoGBAIDGqJH/Pta9+GTzGovE0N0D9j1tUKPl/ocS/m4Ya7fgdQ36q8rTpyFICvan
QUmL8sQsmZ2Nkygt0VSJy/VOr6niQmoi97PY0egxvvK5mtc/nxePCGwYLOMpB6ql
0UptotmvJU3tjyHZbksOf6LlzvpAgk7GnxLF1Cg/RJhH9ubBAkEA6b32mr52u3Uz
BjbVWez1XBcxgwHk8A4NF9yCpHtVRY3751FZbrhy7oa+ZvYokxS4dzrepZlB1dqX
IXaq7CgakQJBAMuwpG4N5x1/PfLODD7PYaJ5GSIx6BZoJObnx/42PrIm2gQdfs6W
1aClscqMyj5vSBF+cWWqu1i7j6+qugSswIUCQA3T3BPZcqKyUztp4QM53mX9RUOP
yCBfZGzl8aCTXz8HIEDV8il3pezwcbEbnNjen+8Fv4giYd+p18j2ATSJRtECQGaE
lG3Tz4PYG/zN2fnu9KwKmSzNw4srhY82D0GSWcHerhIuKjmeTw0Y+EAC1nPQHIy5
gCd0Y/DIDgyTOCbML+UCQQClbgAoYnIpbTUklWH00Z1xr+Y95BOjb4lyjyIF98B2
FA0nM8cHuN/VLKjjcrJUK47lZEOsjLv+qTl0i0Lp6giq
-----END RSA PRIVATE KEY-----
EOT

RSA_PUBLIC_KEY_DKIM = "v=DKIM1; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC5+utIbbfbpssvW0TboF73Seos+1ijdPFGwc/z8Yu12cpjBvRb5/qRJd83XCySRs0QkK1zWx4soPffbtyJ9TU5mO76M23lIuI5slJ4QLA0UznGxfHdfXpK9qRnmG6A4HRHC9B93pjTo6iBksRhIeSsTL94EbUJ625i0Lqg4i6NVQIDAQAB;"

DOMAIN = "duncanthrax.net"
SELECTOR = "cheezburger"

PDKIM_RETURN_CODES = ["PDKIM_VERIFY_NONE", "PDKIM_VERIFY_INVALID", "PDKIM_VERIFY_FAIL", "PDKIM_VERIFY_PASS"]

TEST_MESSAGE = [
  "From: Tom Kistner <tom@duncanthrax.net>",
  "X-Folded-Header: line one",
  "\tline two",
  "To: PDKIM User",
  "Subject: PDKIM Test",
  "",
  "Test 1, 2, 3, 4",
  "This is a simple test of Ruby PDKIM."
]

GMAIL_MESSAGE = [
  "Return-Path: <mjwelchphd@gmail.com>",
  "Delivered-To: <mike@czarmail.com>",
  "Received: from mail.czarmail.com ([127.0.0.1])",
  "by mail.czarmail.com (Dovecot) with LMTP id HPnFC1749FXScwAAk+HNSA",
  "for <mike@czarmail.com>; Sun, 13 Sep 2015 04:15:26 +0000",
  "Received: from mail-ob0-f182.google.com ([209.85.214.182])",
  "by mail.czarmail.com with esmtps (TLS1.2:ECDHE_RSA_AES_128_GCM_SHA256:128)",
  "(Exim 4.84)",
  "(envelope-from <mjwelchphd@gmail.com>)",
  "id 1ZayhK-0007yo-4x",
  "for mike@czarmail.com; Sun, 13 Sep 2015 04:15:26 +0000",
  "Received: by obbbh8 with SMTP id bh8so87258669obb.0",
  "        for <mike@czarmail.com>; Sat, 12 Sep 2015 21:15:20 -0700 (PDT)",
  "DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;",
  "        d=gmail.com; s=20120113;",
  "        h=message-id:date:from:user-agent:mime-version:to:subject",
  "         :content-type;",
  "        bh=b5sxcaTHTBZk9dR5EZlyI7ZLry+IqWAEczMHBzJlJl0=;",
  "        b=DUUrLSYNT9tZvOiBPq4f8K651dqnLuGIOiDjGB7I0kVFfuIW6Nb3jWlbeDhPcOychV",
  "         al8DptP2iNm+iMWHi9KcEA7ZzN78IoNYVYVDTzfmDnDXSnh2u0tPPgk9fnuLUWSJf3D+",
  "         XP9hMvJxhSE52icxf7dhhGI2x+Qw4+Bb9dNpi75tej1ycYMHO6bCYwOmQsYjGh+3F2ui",
  "         y28BBkj+UXTEC7EwkcUj6lHEnYb5SMHN6lYmt/TMWza1ZyqbmvHOSxpRjXD9n4nhrwvi",
  "         HQZacUSYIFzho7dtThNcNFklyNQxqFWTBqsQUFyjZKr2JhcnZe11RVilaVFLkUwK2Tcy",
  "         uIHw==",
  "X-Received: by 10.182.33.73 with SMTP id p9mr5546532obi.73.1442117720794;",
  "        Sat, 12 Sep 2015 21:15:20 -0700 (PDT)",
  "Received: from [192.168.1.2] ([96.251.113.83])",
  "        by smtp.googlemail.com with ESMTPSA id f3sm3789496obm.18.2015.09.12.21.15.19",
  "        for <mike@czarmail.com>",
  "        (version=TLSv1.2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);",
  "        Sat, 12 Sep 2015 21:15:19 -0700 (PDT)",
  "Message-ID: <55F4F854.3060104@gmail.com>",
  "Date: Sat, 12 Sep 2015 21:15:16 -0700",
  "From: \"Michael J. Welch, Ph.D.\" <mjwelchphd@gmail.com>",
  "User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:31.0) Gecko/20100101 Thunderbird/31.2.0",
  "MIME-Version: 1.0",
  "To: Czar Mike <mike@czarmail.com>",
  "Subject: Test of the Ruby Gem for PDKIM",
  "Content-Type: multipart/alternative;",
  " boundary=\"------------020802090102030008090109\"",
  "CzarMail-ID: efb5d62ea0b98820bb04017b4a2334a0",
  "",
  "This is a multi-part message in MIME format.",
  "--------------020802090102030008090109",
  "Content-Type: text/plain; charset=utf-8; format=flowed",
  "Content-Transfer-Encoding: 7bit",
  "",
  "This is a test of the pdkim gem. This email contains some HTML.",
  "",
  "Here is some *bold* type.",
  "",
  "Here is a link to Czar Mail <www.czarmail.com>.",
  "",
  "",
  "--------------020802090102030008090109",
  "Content-Type: text/html; charset=utf-8",
  "Content-Transfer-Encoding: 7bit",
  "",
  "<html>",
  "  <head>",
  "",
  "    <meta http-equiv=\"content-type\" content=\"text/html; charset=utf-8\">",
  "  </head>",
  "  <body bgcolor=\"#FFFFFF\" text=\"#000000\">",
  "    This is a test of the pdkim gem. This email contains some HTML.<br>",
  "    <br>",
  "    Here is some <b>bold</b> type.<br>",
  "    <br>",
  "    Here is a link to <a href=\"www.czarmail.com\">Czar Mail</a>.<br>",
  "    <br>",
  "  </body>",
  "</html>",
  "",
  "--------------020802090102030008090109--"
]

# the dkim header expected from this message is:
#DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=simple/simple; d=duncanthrax.net; s=cheezburger;
#	h=Subject:To:From; bh=+oeSNE7b9Ka6Gdh9ItFGX3J6Wacjc/JxAUaId7ON0T0=;
#	b=Ap6DcX3x2MEoj1E3KBow7NF/2g5CnUoqkt0hgqJ0DufuOsFAPLl0tYA+yYIoCp8Acn/BJkjVYY+WQ7mlSUJfrZEZYIq1P+BZgBdP+Z+g3vrK2zEJchvwpnP0+xKniIktxT2WRQOoH3HBb/5Z1AhtuNfPEoE+kZN22Gksto4bqdg=;

class PdkimTest

  include PDKIM

  def main
    puts
    puts
    test1
    puts
    puts
    test2
    puts
    puts
    test3
    puts
  end

  def display(name, unsigned_message, signed_message, signatures)
    puts name.upcase
    if !unsigned_message.nil?
      puts "------------------------------------------------------------"
      puts "---- The test email before signing.                        -"
      puts "------------------------------------------------------------"
      puts unsigned_message.join(CRLF)+CRLF
    end
    puts
    puts "------------------------------------------------------------"
    puts "---- The test email after signing.                         -"
    puts "------------------------------------------------------------"
    puts signed_message.join(CRLF)+CRLF
    puts
    case
    when signatures.size==0
      puts "------------------------------------------------------------"
      puts "---- The no DKIM headers were found:                       -"
      puts "------------------------------------------------------------"
    when signatures.size==1
      puts "------------------------------------------------------------"
      puts "---- The signature of the DKIM header:                     -"
      puts "------------------------------------------------------------"
      signatures.each { |signature| puts "- %-36s%-20s -"%[signature[:domain], PDKIM_RETURN_CODES[signature[:verify_status]]] }
      puts "------------------------------------------------------------"
    else
      puts "------------------------------------------------------------"
      puts "---- The signatures of the DKIM headers:                   -"
      puts "------------------------------------------------------------"
      signatures.each { |signature| puts "%-38s%-20s -"%[signature[:domain], PDKIM_RETURN_CODES[signature[:verify_status]]] }
      puts "------------------------------------------------------------"
    end
  end

  def test1
    # ---------- SIGN ----------
    ctx = pdkim_init_sign(PDKIM_INPUT_NORMAL, DOMAIN, SELECTOR, RSA_PRIVATE_KEY)
#    ok = pdkim_set_debug_stream(ctx, 2) # 2 --> STDERR
    ok = pdkim_set_optional(ctx, nil, nil, PDKIM_CANON_SIMPLE, PDKIM_CANON_SIMPLE, -1, PDKIM_ALGO_RSA_SHA256, 0, 0)
    TEST_MESSAGE.each do |line| 
      ok = pdkim_feed(ctx, line+CRLF, line.length+2)
    end
    signatures = pdkim_feed_finish(ctx)
    signed_message = [signatures[0][:signature]]
    signed_message.concat(TEST_MESSAGE)
    pdkim_free_ctx(ctx)

    # --------- VERIFY ---------
    # the block on this call is mandatory, and handles the DNS lookup
    # to get the domain's public key
    ctx = pdkim_init_verify(PDKIM_INPUT_NORMAL) do |name|
      RSA_PUBLIC_KEY_DKIM
    end
    signed_message.each do |line|
      ok = pdkim_feed(ctx, line+CRLF, line.length+2)
    end
    signatures = pdkim_feed_finish(ctx)
    pdkim_free_ctx(ctx)
    display("TEST1 -- SIGNING/VERIFYING THE LONG WAY", TEST_MESSAGE, signed_message, signatures)
  end

  def test2
    ok, signed_message = pdkim_sign_an_email(PDKIM_INPUT_NORMAL, DOMAIN, SELECTOR, RSA_PRIVATE_KEY, PDKIM_CANON_SIMPLE, PDKIM_CANON_SIMPLE, TEST_MESSAGE)
    ok, signatures = pdkim_verify_an_email(PDKIM_INPUT_NORMAL, signed_message, :fake_domain_lookup)
    display("TEST2 -- SIGNING/VERIFYING THE SHORT WAY", TEST_MESSAGE, signed_message, signatures)
  end
  
  def fake_domain_lookup(name)
    RSA_PUBLIC_KEY_DKIM
  end

  # If Google ever removes the selector in this test email, this will cease to function
  def test3
    ok, signatures = pdkim_verify_an_email(PDKIM_INPUT_NORMAL, GMAIL_MESSAGE)
    display("TEST3 -- VERIFYING A GMAIL SIGNATURE", nil, GMAIL_MESSAGE, signatures)
  end

end

PdkimTest.new.main



